---
import AuthLayout from '../../layouts/AuthLayout.astro';
import ConfirmEmail from '../../components/auth/ConfirmEmail.tsx';
import { createSupabaseServerInstance } from '../../db/supabase.client.ts';

const title = "Potwierdzenie e-maila - JustFuel";
const description = "Potwierdź swój adres e-mail";

// Handle email confirmation on server side where we have access to cookies
let confirmationStatus: 'processing' | 'success' | 'error' = 'processing';
let confirmationMessage = 'Przetwarzanie potwierdzenia...';
let redirectTo = '/';

if (Astro.url.searchParams.has('code')) {
  const code = Astro.url.searchParams.get('code');
  
  if (code) {
    try {
      const supabase = createSupabaseServerInstance({
        cookies: Astro.cookies,
        headers: Astro.request.headers,
      });

      // Exchange code for session - this will use code verifier from cookies
      const { data, error } = await supabase.auth.exchangeCodeForSession(code);

      if (error) {
        throw error;
      }

      if (data.session) {
        confirmationStatus = 'success';
        confirmationMessage = 'E-mail został potwierdzony pomyślnie!';
        redirectTo = '/';
      } else {
        throw new Error('Nie udało się potwierdzić e-maila');
      }
    } catch (error) {
      console.error('Email confirmation error:', error);
      confirmationStatus = 'error';
      confirmationMessage =
        error instanceof Error
          ? error.message
          : 'Wystąpił błąd podczas potwierdzania e-maila. Spróbuj ponownie.';
    }
  }
} else {
  // No code - check if already logged in
  try {
    const supabase = createSupabaseServerInstance({
      cookies: Astro.cookies,
      headers: Astro.request.headers,
    });

    const { data: { session } } = await supabase.auth.getSession();

    if (session) {
      confirmationStatus = 'success';
      confirmationMessage = 'E-mail został potwierdzony pomyślnie!';
      redirectTo = '/';
    } else {
      confirmationStatus = 'error';
      confirmationMessage = 'Link potwierdzający jest nieprawidłowy lub wygasł. Spróbuj zarejestrować się ponownie.';
    }
  } catch (error) {
    confirmationStatus = 'error';
    confirmationMessage = 'Wystąpił błąd podczas sprawdzania sesji.';
  }
}

// If successful, redirect after a short delay (handled by client component)
// Pass Supabase credentials for client-side hash fragment handling (fallback)
const supabaseUrl = import.meta.env.SUPABASE_URL;
const supabaseKey = import.meta.env.SUPABASE_KEY;
---

<AuthLayout title={title} description={description}>
  <ConfirmEmail 
    client:load 
    status={confirmationStatus} 
    message={confirmationMessage}
    redirectTo={redirectTo}
    supabaseUrl={supabaseUrl}
    supabaseKey={supabaseKey}
  />
</AuthLayout>

