---
import AuthLayout from "../../layouts/AuthLayout.astro";
import ResetPasswordForm from "../../components/auth/ResetPasswordForm.tsx";
import { createSupabaseServerInstance } from "../../db/supabase.client.ts";

const title = "Resetowanie hasła - JustFuel";
const description = "Ustaw nowe hasło do swojego konta JustFuel";

// Check if user has a valid reset session
// When user clicks reset link from email, Supabase redirects with a code parameter
let hasValidSession = false;
let sessionError: string | null = null;

// Handle code parameter from email link (similar to confirm.astro)
if (Astro.url.searchParams.has("code")) {
  const code = Astro.url.searchParams.get("code");

  if (code) {
    try {
      const supabase = createSupabaseServerInstance({
        cookies: Astro.cookies,
        headers: Astro.request.headers,
      });

      // Exchange code for session - this will create a session with reset token
      const { data, error } = await supabase.auth.exchangeCodeForSession(code);

      if (error) {
        throw error;
      }

      if (data.session) {
        hasValidSession = true;
        // Clear code from URL
        return Astro.redirect(Astro.url.pathname);
      } else {
        throw new Error("Nie udało się utworzyć sesji resetującej");
      }
    } catch (error) {
      console.error("Password reset code exchange error:", error);
      sessionError =
        error instanceof Error
          ? error.message
          : "Wystąpił błąd podczas przetwarzania linku resetującego. Spróbuj ponownie.";
    }
  }
} else {
  // No code - check if already has a valid session
  try {
    const supabase = createSupabaseServerInstance({
      cookies: Astro.cookies,
      headers: Astro.request.headers,
    });

    const {
      data: { session },
      error,
    } = await supabase.auth.getSession();

    if (error) {
      sessionError = error.message;
    } else if (session) {
      hasValidSession = true;
    } else {
      sessionError = "Token resetowania jest nieprawidłowy lub wygasł";
    }
  } catch (error) {
    console.error("Session check error:", error);
    sessionError = "Wystąpił błąd podczas sprawdzania sesji";
  }
}

// Pass Supabase credentials for client-side hash fragment handling (fallback)
// Hash fragments are not available server-side, so we need client-side handling
const supabaseUrl = import.meta.env.SUPABASE_URL;
const supabaseKey = import.meta.env.SUPABASE_KEY;
---

<AuthLayout title={title} description={description}>
  <ResetPasswordForm
    hasValidSession={hasValidSession}
    sessionError={sessionError}
    supabaseUrl={supabaseUrl}
    supabaseKey={supabaseKey}
    client:load
  />
</AuthLayout>
